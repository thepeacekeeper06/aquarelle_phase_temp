<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature Monitoring Dashboard</title>
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/apexcharts" as="script">
    
    <!-- Load CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f6f8;
            color: #333;
            transition: background-color 0.5s ease;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-weight: bold;
        }
        
        .temp-display {
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
            transition: color 0.3s ease;
        }
        
        .temp-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: center;
        }
        
        .temp-warning {
            color: #dc3545 !important;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        #chart {
            min-height: 400px;
        }
        
        .high-temp-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }
        
        .high-temp-warning {
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        .form-control, .form-check-input {
            transition: all 0.3s ease;
        }
        
        .updating {
            animation: updateFade 0.5s ease;
        }
        
        @keyframes updateFade {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .toast {
            position: relative;
            z-index: 1080;
        }
        
        .toast-info {
            background-color: #17a2b8 !important;
        }
        
        .icon-rotate {
            transition: transform 0.3s ease;
        }
        
        .icon-rotate.open {
            transform: rotate(180deg);
        }
        
        /* Explicit collapsible content styling */
        .collapse-content {
            height: 0;
            overflow: hidden;
            transition: height 0.3s ease;
            padding: 0;
        }
        
        .collapse-content.show {
            height: auto;
            padding: 1rem;
        }
        
        .collapsible-header {
            cursor: pointer;
        }
        
        /* Custom axis controls styling */
        #axisControls {
            display: none;
            transition: all 0.3s ease;
            padding-top: 15px;
        }
        
        #axisControls.show {
            display: block;
        }
        
        .axis-toggle {
            cursor: pointer;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-top: 10px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <h1 class="text-center mb-4">Temperature Monitoring Dashboard</h1>
        
        <!-- Filters and Controls -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">Filters & Controls</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="d-flex gap-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="phaseR" checked>
                                        <label class="form-check-label" for="phaseR">
                                            Phase R
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="phaseY" checked>
                                        <label class="form-check-label" for="phaseY">
                                            Phase Y
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="phaseB" checked>
                                        <label class="form-check-label" for="phaseB">
                                            Phase B
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="dateFilter" class="form-label">Select Date:</label>
                                <input type="date" class="form-control" id="dateFilter">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="thresholdInput" class="form-label">Threshold (°C):</label>
                                <input type="number" class="form-control" id="thresholdInput" placeholder="e.g., 50">
                            </div>
                            <div class="col-md-3 mb-3 d-flex align-items-end">
                                <button id="applyThreshold" class="btn btn-primary w-100">Apply Threshold</button>
                            </div>
                        </div>
                        
                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="axis-toggle" id="axisCustomToggle">
                                    <i class="fas fa-cog me-2"></i> Customize Axis Ranges
                                    <i class="fas fa-chevron-down float-end icon-rotate" id="toggleIcon"></i>
                                </div>
                                <div id="axisControls">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header">X-Axis Range (Time)</div>
                                                <div class="card-body">
                                                    <div class="form-check mb-3">
                                                        <input class="form-check-input" type="checkbox" id="customXaxis">
                                                        <label class="form-check-label" for="customXaxis">
                                                            Custom X-Axis Range
                                                        </label>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <label for="xaxisMin" class="form-label">Start Time:</label>
                                                            <input type="time" class="form-control" id="xaxisMin" disabled>
                                                        </div>
                                                        <div class="col-6">
                                                            <label for="xaxisMax" class="form-label">End Time:</label>
                                                            <input type="time" class="form-control" id="xaxisMax" disabled>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header">Y-Axis Range (Temperature)</div>
                                                <div class="card-body">
                                                    <div class="form-check mb-3">
                                                        <input class="form-check-input" type="checkbox" id="customYaxis">
                                                        <label class="form-check-label" for="customYaxis">
                                                            Custom Y-Axis Range
                                                        </label>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <label for="yaxisMin" class="form-label">Min Temp:</label>
                                                            <input type="number" class="form-control" id="yaxisMin" placeholder="e.g., 0" disabled>
                                                        </div>
                                                        <div class="col-6">
                                                            <label for="yaxisMax" class="form-label">Max Temp:</label>
                                                            <input type="number" class="form-control" id="yaxisMax" placeholder="e.g., 100" disabled>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12 text-center">
                                            <button id="applyAxisSettings" class="btn btn-success">Apply Axis Settings</button>
                                            <button id="resetAxisSettings" class="btn btn-secondary ms-2">Reset to Dynamic</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chart and Highest Temperature Section -->
        <div class="row mb-4">
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">Temperature Trends</div>
                    <div class="card-body">
                        <div id="chart"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-header">Highest Temperatures Today</div>
                    <div class="card-body p-0">
                        <div id="highTempContainer">
                            <div class="high-temp-item" id="highTempR">
                                <div class="d-flex justify-content-between">
                                    <strong>Phase R:</strong>
                                    <span class="high-temp-value">N/A</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">Recorded at:</small>
                                    <small class="high-temp-time">--:--</small>
                                </div>
                            </div>
                            <div class="high-temp-item" id="highTempY">
                                <div class="d-flex justify-content-between">
                                    <strong>Phase Y:</strong>
                                    <span class="high-temp-value">N/A</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">Recorded at:</small>
                                    <small class="high-temp-time">--:--</small>
                                </div>
                            </div>
                            <div class="high-temp-item" id="highTempB">
                                <div class="d-flex justify-content-between">
                                    <strong>Phase B:</strong>
                                    <span class="high-temp-value">N/A</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">Recorded at:</small>
                                    <small class="high-temp-time">--:--</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Real-Time Data Display -->
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="temp-display" id="tempR">N/A</div>
                        <div class="temp-label">Phase R (°C)</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="temp-display" id="tempY">N/A</div>
                        <div class="temp-label">Phase Y (°C)</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="temp-display" id="tempB">N/A</div>
                        <div class="temp-label">Phase B (°C)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast container for notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Load scripts in optimal order -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    
    <script>
        let chartData = [];
        let chart;
        let threshold = null;
        
        // This is the main spreadsheet URL with your provided ID
        const SPREADSHEET_ID = "1l4xn1VXk9y4uFU--L3L5GzY3JJ8jaX_PNxYWQCpEh0Y";
        const SPREADSHEET_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json`;
        
        // This is the URL that will receive the threshold update request - using your Apps Script ID
        const APPS_SCRIPT_ID = "AKfycbxmNmFndYc-C1CzF1p5ABL24xer7pDEd2BtCLY2S3Bdq2JyxFJYtPbqgG7Qq56rOiyx";
        const APPS_SCRIPT_URL = `https://script.google.com/macros/s/${APPS_SCRIPT_ID}/exec`;
        
        let customXaxis = false;
        let customYaxis = false;
        let xaxisMinValue = null;
        let xaxisMaxValue = null;
        let yaxisMinValue = null;
        let yaxisMaxValue = null;
        
        // Calculate average of an array
        function calculateAverage(arr) {
            if (arr.length === 0) return null;
            const sum = arr.reduce((acc, val) => acc + val, 0);
            return sum / arr.length;
        }
        
        // Format date for input field (YYYY-MM-DD)
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Process data into 10-minute intervals - optimized version
        function processDataBy10MinIntervals(data) {
            const intervalMap = new Map();
            
            for (let i = 0; i < data.length; i++) {
                const item = data[i];
                // Round to the nearest 10-minute interval
                const date = new Date(item.timestamp);
                date.setMinutes(Math.floor(date.getMinutes() / 10) * 10);
                date.setSeconds(0);
                date.setMilliseconds(0);
                
                const key = date.getTime();
                
                if (!intervalMap.has(key)) {
                    intervalMap.set(key, {
                        timestamp: date,
                        phaseR: [],
                        phaseY: [],
                        phaseB: []
                    });
                }
                
                const interval = intervalMap.get(key);
                if (item.phaseR !== null) interval.phaseR.push(item.phaseR);
                if (item.phaseY !== null) interval.phaseY.push(item.phaseY);
                if (item.phaseB !== null) interval.phaseB.push(item.phaseB);
            }
            
            // Convert map to array and calculate averages
            return Array.from(intervalMap.values())
                .map(interval => ({
                    timestamp: interval.timestamp,
                    phaseR: calculateAverage(interval.phaseR),
                    phaseY: calculateAverage(interval.phaseY),
                    phaseB: calculateAverage(interval.phaseB)
                }))
                .sort((a, b) => a.timestamp - b.timestamp);
        }
        
        // Show a toast notification using a simpler implementation
        function showToast(message, type = 'success') {
            // Create a unique ID for this toast
            const toastId = 'toast-' + Date.now();
            
            // Determine the appropriate background color
            let bgClass = 'bg-success';
            if (type === 'error') bgClass = 'bg-danger';
            if (type === 'info') bgClass = 'bg-info';
            
            // Determine the appropriate icon
            let icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-triangle';
            if (type === 'info') icon = 'info-circle';
            
            // Create the toast HTML
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${icon} me-2"></i> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            // Append toast to container
            document.querySelector('.toast-container').insertAdjacentHTML('beforeend', toastHtml);
            
            // Create and show the toast, then remove after 5 seconds
            const toastEl = document.getElementById(toastId);
            toastEl.classList.add('show');
            
            setTimeout(() => {
                toastEl.classList.remove('show');
                setTimeout(() => toastEl.remove(), 300);
            }, 5000);
        }
        
        // Initialize chart with empty data - optimized
        function initChart() {
            const options = {
                series: [
                    { name: 'Phase R (°C)', data: [] },
                    { name: 'Phase Y (°C)', data: [] },
                    { name: 'Phase B (°C)', data: [] }
                ],
                chart: {
                    type: 'line',
                    height: 400,
                    fontFamily: 'Arial, sans-serif',
                    animations: {
                        enabled: true,
                        easing: 'easeinout',
                        speed: 800,
                        dynamicAnimation: {
                            enabled: true,
                            speed: 350
                        }
                    },
                    toolbar: {
                        show: true,
                        offsetY: 30,
                        tools: {
                            download: true,
                            selection: true,
                            zoom: true,
                            zoomin: true,
                            zoomout: true,
                            pan: true,
                            reset: true
                        },
                        autoSelected: 'zoom'
                    }
                },
                colors: ['#FF5733', '#F3C623', '#33A1FF'],
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                markers: {
                    size: 4,
                    hover: {
                        size: 6
                    }
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        datetimeUTC: false,
                        format: 'HH:mm'
                    },
                    title: {
                        text: 'Time'
                    }
                },
                yaxis: {
                    title: {
                        text: 'Temperature (°C)'
                    },
                    forceNiceScale: true,
                    labels: {
                        formatter: function(val) {
                            return val.toFixed(2);
                        }
                    },
                    decimalsInFloat: 2
                },
                tooltip: {
                    x: {
                        format: 'dd MMM yyyy HH:mm'
                    },
                    y: {
                        formatter: function(val) {
                            return val.toFixed(2) + ' °C';
                        }
                    }
                },
                legend: {
                    position: 'bottom'
                },
                grid: {
                    borderColor: '#e0e0e0',
                    row: {
                        colors: ['#f3f3f3', 'transparent'],
                        opacity: 0.5
                    }
                },
                annotations: {
                    yaxis: []
                }
            };

            chart = new ApexCharts(document.querySelector("#chart"), options);
            chart.render();
        }
        
        // Optimized JSON parsing
        function parseSpreadsheetResponse(responseText) {
            // Extract the JSON part from the response
            const jsonStart = responseText.indexOf('{');
            const jsonEnd = responseText.lastIndexOf('}') + 1;
            if (jsonStart < 0 || jsonEnd <= 0) {
                throw new Error('Invalid response format');
            }
            
            return JSON.parse(responseText.substring(jsonStart, jsonEnd));
        }

        // Process spreadsheet data efficiently
        function processSpreadsheetData(json) {
            if (!json.table || !json.table.rows) return [];
            
            return json.table.rows.map(row => ({
                timestamp: new Date(row.c[0].v),
                phaseR: row.c[1]?.v ?? null,
                phaseY: row.c[2]?.v ?? null,
                phaseB: row.c[3]?.v ?? null
            }));
        }

        // Fetch data from the spreadsheet - optimized with a single fetch
        function fetchDataAndThreshold() {
            return fetch(SPREADSHEET_URL)
                .then(response => response.text())
                .then(data => {
                    try {
                        const json = parseSpreadsheetResponse(data);
                        
                        // Process data for chart
                        const rawData = processSpreadsheetData(json);
                        chartData = processDataBy10MinIntervals(rawData);
                        
                        // Set the date filter to today if it's not already set
                        const dateFilter = document.getElementById('dateFilter');
                        if (!dateFilter.value) {
                            dateFilter.value = formatDateForInput(new Date());
                        }
                        
                        // Look for threshold in the first few rows
                        if (json.table && json.table.rows) {
                            for (let i = 0; i < Math.min(5, json.table.rows.length); i++) {
                                const row = json.table.rows[i];
                                if (row && row.c && row.c.length > 5 && row.c[5] && row.c[5].v) {
                                    const possibleThreshold = parseFloat(row.c[5].v);
                                    if (!isNaN(possibleThreshold)) {
                                        document.getElementById('thresholdInput').value = possibleThreshold;
                                        threshold = possibleThreshold;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // Get the latest data point for real-time display
                        if (rawData.length > 0) {
                            const latest = rawData[rawData.length - 1];
                            updateTemperatureDisplay('tempR', latest.phaseR);
                            updateTemperatureDisplay('tempY', latest.phaseY);
                            updateTemperatureDisplay('tempB', latest.phaseB);
                        }
                        
                        // Update chart
                        updateChart();
                        
                        // Explicitly update highest temperatures using raw data
                        updateHighestTemperaturesFromData(rawData);
                        
                        return json; // Return for potential further use
                    } catch (e) {
                        console.error('Error processing data:', e);
                        showToast('Error processing data', 'error');
                        throw e;
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    showToast('Error fetching data', 'error');
                });
        }

        // Save threshold to spreadsheet - optimized
        function saveThreshold(thresholdValue) {
            showToast('Attempting to save threshold...', 'info');
            
            // Create a timestamp for cache busting
            const timestamp = new Date().getTime();
            const requestUrl = `${APPS_SCRIPT_URL}?action=updateThreshold&value=${thresholdValue}&sheet=Phase-Temperature&cell=F3&timestamp=${timestamp}`;
            
            // Use Image approach (most reliable for cross-domain requests)
            const img = new Image();
            img.onload = () => showToast('Threshold saved successfully!', 'success');
            img.onerror = () => showToast('Threshold value sent to server', 'info');
            img.src = requestUrl;
            
            // Update the UI threshold line immediately
            updateThresholdLine();
        }
        
        // Update temperature display with animation - optimized
        function updateTemperatureDisplay(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Prepare display value
            const displayValue = value !== null ? value.toFixed(2) : 'N/A';
            
            // Add animation class and update
            element.classList.add('updating');
            element.textContent = displayValue;
            
            // Apply warning style
            if (threshold !== null && value !== null && value > threshold) {
                element.classList.add('temp-warning');
            } else {
                element.classList.remove('temp-warning');
            }
            
            // Remove animation class
            setTimeout(() => element.classList.remove('updating'), 400);
        }
        
        // Update the chart with the latest data - optimized
        function updateChart() {
            if (chartData.length === 0) return;

            const showPhaseR = document.getElementById('phaseR').checked;
            const showPhaseY = document.getElementById('phaseY').checked;
            const showPhaseB = document.getElementById('phaseB').checked;
            
            // Filter by date
            let filteredData = chartData;
            const dateFilter = document.getElementById('dateFilter').value;
            
            if (dateFilter) {
                const selectedDate = new Date(dateFilter);
                const year = selectedDate.getFullYear();
                const month = selectedDate.getMonth();
                const day = selectedDate.getDate();
                
                filteredData = chartData.filter(item => {
                    const itemDate = item.timestamp;
                    return itemDate.getFullYear() === year &&
                           itemDate.getMonth() === month &&
                           itemDate.getDate() === day;
                });
            }
            
            // Prepare series data efficiently
            const seriesData = [
                {
                    name: 'Phase R (°C)',
                    data: showPhaseR ? filteredData.map(item => [item.timestamp.getTime(), item.phaseR]) : []
                },
                {
                    name: 'Phase Y (°C)',
                    data: showPhaseY ? filteredData.map(item => [item.timestamp.getTime(), item.phaseY]) : []
                },
                {
                    name: 'Phase B (°C)',
                    data: showPhaseB ? filteredData.map(item => [item.timestamp.getTime(), item.phaseB]) : []
                }
            ];
            
            // Update chart series and options in one operation if possible
            const updateOptions = {};
            
            // Handle custom axis settings
            if (customXaxis && filteredData.length > 0) {
                const selectedDate = new Date(dateFilter);
                
                if (xaxisMinValue && xaxisMaxValue) {
                    const startTimeParts = xaxisMinValue.split(':');
                    const endTimeParts = xaxisMaxValue.split(':');
                    
                    const minTime = new Date(selectedDate);
                    minTime.setHours(parseInt(startTimeParts[0]), parseInt(startTimeParts[1]), 0);
                    
                    const maxTime = new Date(selectedDate);
                    maxTime.setHours(parseInt(endTimeParts[0]), parseInt(endTimeParts[1]), 0);
                    
                    updateOptions.xaxis = {
                        min: minTime.getTime(),
                        max: maxTime.getTime()
                    };
                }
            }
            
            if (customYaxis) {
                if (yaxisMinValue !== null && yaxisMaxValue !== null) {
                    updateOptions.yaxis = {
                        min: yaxisMinValue,
                        max: yaxisMaxValue
                    };
                }
            }
            
            // Add threshold line if set
            if (threshold !== null) {
                updateOptions.annotations = {
                    yaxis: [{
                        y: threshold,
                        borderColor: '#FF4560',
                        label: {
                            borderColor: '#FF4560',
                            style: {
                                color: '#fff',
                                background: '#FF4560'
                            },
                            text: `Threshold: ${threshold.toFixed(2)}°C`,
                            position: 'left'
                        }
                    }]
                };
            } else {
                updateOptions.annotations = {
                    yaxis: []
                };
            }
            
            // Apply all updates in a single operation
            chart.updateOptions(updateOptions);
            chart.updateSeries(seriesData);
            
            // Update highest temperatures based on filtered data
            updateHighestTemperatures(filteredData);
        }
        
        // Update the threshold line - simplified
        function updateThresholdLine() {
            const thresholdInput = document.getElementById('thresholdInput').value;
            const thresholdValue = parseFloat(thresholdInput);
            
            if (!isNaN(thresholdValue)) {
                threshold = thresholdValue;
                
                chart.updateOptions({
                    annotations: {
                        yaxis: [{
                            y: threshold,
                            borderColor: '#FF4560',
                            label: {
                                borderColor: '#FF4560',
                                style: {
                                    color: '#fff',
                                    background: '#FF4560'
                                },
                                text: `Threshold: ${threshold.toFixed(2)}°C`,
                                position: 'left'
                            }
                        }]
                    }
                });
                
                // Update warnings
                updateHighestTemperatureWarnings();
            } else {
                chart.updateOptions({
                    annotations: {
                        yaxis: []
                    }
                });
                threshold = null;
                updateHighestTemperatureWarnings();
            }
        }
        
        // Update highest temperatures for the selected day - fixed to ensure loading
        function updateHighestTemperatures(filteredData) {
            // If no filtered data is provided, fetch the raw data
            if (!filteredData || filteredData.length === 0) {
                fetch(SPREADSHEET_URL)
                    .then(response => response.text())
                    .then(data => {
                        try {
                            const json = parseSpreadsheetResponse(data);
                            const rawData = processSpreadsheetData(json);
                            updateHighestTemperaturesFromData(rawData);
                        } catch (e) {
                            console.error('Error fetching highest temperature data:', e);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching highest temperature data:', error);
                    });
            } else {
                // Use the provided filtered data
                updateHighestTemperaturesFromData(filteredData);
            }
        }
        
        // Helper function to update highest temperatures from data
        function updateHighestTemperaturesFromData(data) {
            if (!data || data.length === 0) {
                // No data available, reset displays
                updateHighestTemperatureDisplay('highTempR', { value: null, timestamp: null });
                updateHighestTemperatureDisplay('highTempY', { value: null, timestamp: null });
                updateHighestTemperatureDisplay('highTempB', { value: null, timestamp: null });
                return;
            }
            
            const dateFilter = document.getElementById('dateFilter').value;
            const selectedDate = new Date(dateFilter);
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();
            const day = selectedDate.getDate();
            
            // Find highest values for each phase
            let highestR = { value: null, timestamp: null };
            let highestY = { value: null, timestamp: null };
            let highestB = { value: null, timestamp: null };
            
            // Filter data for selected date and find highest values
            for (let i = 0; i < data.length; i++) {
                const item = data[i];
                const itemDate = item.timestamp;
                
                // Check if item is from the selected date
                if (itemDate.getFullYear() === year && 
                    itemDate.getMonth() === month && 
                    itemDate.getDate() === day) {
                    
                    // Phase R
                    if (item.phaseR !== null) {
                        if (highestR.value === null || item.phaseR > highestR.value) {
                            highestR = { value: item.phaseR, timestamp: item.timestamp };
                        }
                    }
                    
                    // Phase Y
                    if (item.phaseY !== null) {
                        if (highestY.value === null || item.phaseY > highestY.value) {
                            highestY = { value: item.phaseY, timestamp: item.timestamp };
                        }
                    }
                    
                    // Phase B
                    if (item.phaseB !== null) {
                        if (highestB.value === null || item.phaseB > highestB.value) {
                            highestB = { value: item.phaseB, timestamp: item.timestamp };
                        }
                    }
                }
            }
            
            console.log('Highest temps:', { highestR, highestY, highestB });
            
            // Update UI with the highest values
            updateHighestTemperatureDisplay('highTempR', highestR);
            updateHighestTemperatureDisplay('highTempY', highestY);
            updateHighestTemperatureDisplay('highTempB', highestB);
            
            // Update warning colors
            updateHighestTemperatureWarnings();
        }
        
        // Update highest temperature display - simplified
        function updateHighestTemperatureDisplay(elementId, data) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const valueEl = element.querySelector('.high-temp-value');
            const timeEl = element.querySelector('.high-temp-time');
            
            if (data.value !== null) {
                valueEl.textContent = data.value.toFixed(2) + ' °C';
                timeEl.textContent = data.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                valueEl.textContent = 'N/A';
                timeEl.textContent = '--:--';
            }
        }
        
        // Update warning colors for highest temperatures
        function updateHighestTemperatureWarnings() {
            updateHighTemperatureWarning('highTempR');
            updateHighTemperatureWarning('highTempY');
            updateHighTemperatureWarning('highTempB');
        }
        
        // Update warning for a single highest temperature - simplified
        function updateHighTemperatureWarning(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const valueEl = element.querySelector('.high-temp-value');
            if (!valueEl) return;
            
            const valueText = valueEl.textContent;
            const isWarning = valueText !== 'N/A' && threshold !== null && 
                              parseFloat(valueText) > threshold;
            
            // Use classList toggle for cleaner code
            element.classList.toggle('high-temp-warning', isWarning);
            valueEl.classList.toggle('text-danger', isWarning);
        }
        
        // Toggle axis customization section
        function toggleAxisControls() {
            const controls = document.getElementById('axisControls');
            const icon = document.getElementById('toggleIcon');
            
            controls.classList.toggle('show');
            icon.classList.toggle('open');
        }
        
        // Apply axis settings
        function applyAxisSettings() {
            customXaxis = document.getElementById('customXaxis').checked;
            customYaxis = document.getElementById('customYaxis').checked;
            
            if (customXaxis) {
                xaxisMinValue = document.getElementById('xaxisMin').value;
                xaxisMaxValue = document.getElementById('xaxisMax').value;
            } else {
                xaxisMinValue = null;
                xaxisMaxValue = null;
            }
            
            if (customYaxis) {
                yaxisMinValue = parseFloat(document.getElementById('yaxisMin').value);
                yaxisMaxValue = parseFloat(document.getElementById('yaxisMax').value);
            } else {
                yaxisMinValue = null;
                yaxisMaxValue = null;
            }
            
            updateChart();
            showToast('Axis settings applied');
        }
        
        // Reset axis settings to dynamic
        function resetAxisSettings() {
            customXaxis = false;
            customYaxis = false;
            xaxisMinValue = null;
            xaxisMaxValue = null;
            yaxisMinValue = null;
            yaxisMaxValue = null;
            
            document.getElementById('customXaxis').checked = false;
            document.getElementById('customYaxis').checked = false;
            document.getElementById('xaxisMin').disabled = true;
            document.getElementById('xaxisMax').disabled = true;
            document.getElementById('yaxisMin').disabled = true;
            document.getElementById('yaxisMax').disabled = true;
            
            updateChart();
            showToast('Reset to dynamic axis scaling');
        }

        // Initialize the dashboard with event delegation and proper async loading
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to today
            document.getElementById('dateFilter').value = formatDateForInput(new Date());
            
            // Initialize chart
            initChart();
            
            // Add a loading indicator
            const loadingToast = document.createElement('div');
            loadingToast.className = 'toast align-items-center text-white bg-info show';
            loadingToast.style.position = 'fixed';
            loadingToast.style.top = '20px';
            loadingToast.style.right = '20px';
            loadingToast.style.zIndex = '1100';
            loadingToast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        Loading dashboard data...
                    </div>
                </div>
            `;
            document.body.appendChild(loadingToast);
            
            // Load remaining scripts in parallel after critical initialization
            function loadScript(src, callback) {
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.onload = callback;
                document.body.appendChild(script);
            }
            
            // Load non-critical scripts after page content is ready
            loadScript('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js', () => {});
            loadScript('https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js', () => {});
            
            // Setup event listeners using delegation where possible
            document.body.addEventListener('change', function(e) {
                // Phase visibility toggles
                if (e.target.id === 'phaseR' || e.target.id === 'phaseY' || e.target.id === 'phaseB') {
                    updateChart();
                }
                
                // Date filter change
                if (e.target.id === 'dateFilter') {
                    updateChart();
                }
                
                // Custom axis checkboxes
                if (e.target.id === 'customXaxis') {
                    document.getElementById('xaxisMin').disabled = !e.target.checked;
                    document.getElementById('xaxisMax').disabled = !e.target.checked;
                }
                
                if (e.target.id === 'customYaxis') {
                    document.getElementById('yaxisMin').disabled = !e.target.checked;
                    document.getElementById('yaxisMax').disabled = !e.target.checked;
                }
            });
            
            // Button click listeners
            document.body.addEventListener('click', function(e) {
                // Apply threshold button
                if (e.target.id === 'applyThreshold') {
                    const thresholdValue = parseFloat(document.getElementById('thresholdInput').value);
                    
                    if (!isNaN(thresholdValue)) {
                        threshold = thresholdValue;
                        updateThresholdLine();
                        saveThreshold(thresholdValue);
                    } else {
                        showToast('Please enter a valid threshold value', 'error');
                    }
                }
                
                // Axis toggle
                if (e.target.id === 'axisCustomToggle' || e.target.closest('#axisCustomToggle')) {
                    toggleAxisControls();
                }
                
                // Apply axis settings
                if (e.target.id === 'applyAxisSettings') {
                    applyAxisSettings();
                }
                
                // Reset axis settings
                if (e.target.id === 'resetAxisSettings') {
                    resetAxisSettings();
                }
            });
            
            // Fetch initial data with a small delay to allow UI to render first
            setTimeout(() => {
                fetchDataAndThreshold().then(() => {
                    // Remove loading indicator
                    const loadingToast = document.querySelector('.toast.bg-info');
                    if (loadingToast) {
                        loadingToast.classList.remove('show');
                        setTimeout(() => loadingToast.remove(), 500);
                    }
                    
                    showToast('Dashboard loaded successfully!', 'success');
                    
                    // Set up periodic refresh after initial load completes
                    setInterval(() => {
                        // Use a simplified fetch that just updates what's needed
                        fetch(SPREADSHEET_URL)
                            .then(response => response.text())
                            .then(data => {
                                try {
                                    const json = parseSpreadsheetResponse(data);
                                    
                                    // Only update real-time displays from latest data point
                                    if (json.table && json.table.rows && json.table.rows.length > 0) {
                                        const latestRow = json.table.rows[json.table.rows.length - 1];
                                        
                                        if (latestRow && latestRow.c && latestRow.c.length >= 4) {
                                            const livePhaseR = latestRow.c[1]?.v ?? null;
                                            const livePhaseY = latestRow.c[2]?.v ?? null;
                                            const livePhaseB = latestRow.c[3]?.v ?? null;
                                            
                                            updateTemperatureDisplay('tempR', livePhaseR);
                                            updateTemperatureDisplay('tempY', livePhaseY);
                                            updateTemperatureDisplay('tempB', livePhaseB);
                                        }
                                    }
                                } catch (e) {
                                    console.error('Error updating live data:', e);
                                }
                            });
                    }, 20000); // Every 20 seconds for live updates
                    
                    // Full data refresh for chart and highest temperatures
                    setInterval(fetchDataAndThreshold, 20000); // Every minute
                }).catch(error => {
                    console.error('Error in initial data load:', error);
                    // Remove loading indicator and show error message
                    const loadingToast = document.querySelector('.toast.bg-info');
                    if (loadingToast) loadingToast.remove();
                    
                    showToast('Error loading dashboard data. Please refresh the page.', 'error');
                });
            }, 100);
        });
    </script>
</body>
</html>
